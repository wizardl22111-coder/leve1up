# ๐ ุฅุนุฏุงุฏ ูุธุงู ุงูุฏูุน ุนุจุฑ Ziina Payment Gateway (API v2)

## ๐ ุงูุฎุทูุงุช ุงููุทููุจุฉ:

### 1๏ธโฃ ุงูุญุตูู ุนูู ููุงุชูุญ API ูู Ziina

1. ุณุฌูู ุฏุฎูู ุฅูู ููุญุฉ ุชุญูู Ziina: https://dashboard.ziina.com/
2. ุงูุชูู ุฅูู ูุณู **API Keys**
3. ุงูุณุฎ **Secret Key** (ูุจุฏุฃ ุจู `sk_test_` ููุชุฌุฑุจุฉ ุฃู `sk_live_` ููุฅูุชุงุฌ)

**ููุงุญุธุฉ:** ูุญู ูุณุชุฎุฏู Ziina API v2 (`https://api-v2.ziina.com/api/payment_intent`)

---

### 2๏ธโฃ ุฅุนุฏุงุฏ ุงููุชุบูุฑุงุช ุงูุจูุฆูุฉ (Environment Variables)

#### ุฃ) ููุชุทููุฑ ุงููุญูู (Local Development):

1. ุฃูุดุฆ ููู `.env.local` ูู ุฌุฐุฑ ุงููุดุฑูุน:
```bash
cp .env.example .env.local
```

2. ุงูุชุญ `.env.local` ูุฃุถู ุงูููุงุชูุญ:
```env
ZIINA_SECRET_KEY=sk_test_your_actual_secret_key_here
NEXT_PUBLIC_APP_URL=http://localhost:3000
```

#### ุจ) ููุฅูุชุงุฌ ุนูู Vercel:

1. ุงุฐูุจ ุฅูู ูุดุฑูุนู ูู Vercel Dashboard
2. ุงูุชูู ุฅูู **Settings** โ **Environment Variables**
3. ุฃุถู ุงููุชุบูุฑุงุช ุงูุชุงููุฉ:

| Key | Value | Environment |
|-----|-------|------------|
| `ZIINA_SECRET_KEY` | `sk_live_your_key` | Production |
| `NEXT_PUBLIC_APP_URL` | `https://your-domain.vercel.app` | Production |

โ๏ธ **ููู:** ูุง ุชุดุงุฑู ููุชุงุญ Ziina ุงูุณุฑู ูุน ุฃู ุดุฎุต!

---

### 3๏ธโฃ ุงุฎุชุจุงุฑ ูุธุงู ุงูุฏูุน

#### ูุถุน ุงูุชุฌุฑุจุฉ (Test Mode):
- ุงุณุชุฎุฏู `test: true` ูู ุฏุงูุฉ `handlePayment` (ููุฌูุฏุฉ ูู `ProductDetail.tsx`)
- ูู ูุชู ุฎุตู ุฃู ูุจูุบ ูุนูู
- ููููู ุงุณุชุฎุฏุงู ุจุทุงูุงุช ุงุฎุชุจุงุฑ ูู Ziina

#### ูุถุน ุงูุฅูุชุงุฌ (Production Mode):
- ุบููุฑ `test: true` ุฅูู `test: false` ูู ุฏุงูุฉ `handlePayment`
- ุณูุชู ุงูุฏูุน ุงููุนูู

---

### 4๏ธโฃ ุงูุชุญูู ูู ุนูู ุงููุธุงู

#### ุงูุชุดุฎูุต ูุงูุชุตุญูุญ:

ูุธุงู ุงูุฏูุน ูุชุถูู **ุชุณุฌูู ุดุงูู (Console Logging)** ููุณุงุนุฏุชู ูู ุงูุชุดุฎูุต:

**ุณุชุฑู ูู Console ุงูุฎุงุต ุจู Vercel ุฃู Terminal:**

```
๐ Ziina API Key exists: true
๐ API Key prefix: sk_test_ab...
๐ App URL: https://yoursite.com
๐ฐ Original amount (AED): 105
๐ฐ Converted amount (fils): 10500
๐ค Sending payment data: { ... }
๐ฅ Response status: 200
๐ฅ Response headers: { ... }
๐ฅ Response text (first 500 chars): ...
โ Parsed response data: { ... }
โ Payment intent created successfully!
โ Redirect URL: https://pay.ziina.com/...
```

**ููุชุฃูุฏ ูู ุตุญุฉ ุงูุฅุนุฏุงุฏ:**

| # | ุงูุฎุทูุฉ | ููููุฉ ุงูุชุญูู |
|---|--------|---------------|
| 1 | ุงููุชุบูุฑุงุช ุงูุจูุฆูุฉ ููุฌูุฏุฉ | ุชุญูู ูู ุฑุณุงูุฉ `๐ Ziina API Key exists: true` |
| 2 | ุงูููุชุงุญ ุตุญูุญ | ุชุญูู ูู `๐ API Key prefix:` ูุจุฏุฃ ุจู `sk_test_` ุฃู `sk_live_` |
| 3 | ุฑุงุจุท ุงููููุน ุตุญูุญ | ุชุญูู ูู `๐ App URL:` ูุทุงุจู ูููุนู |
| 4 | ุชุญููู ุงููุจูุบ ุตุญูุญ | ูุงุฑู `๐ฐ Original` ู `๐ฐ Converted` (ร100) |
| 5 | ุงูุฑุฏ ูุญุชูู redirect_url | ุชุญูู ูู ูุฌูุฏ `โ Redirect URL:` |
| 6 | ูุถุน ุงูุชุฌุฑุจุฉ ูุดุท | ุชุญูู ูู `"test": true` ูู ุงูุจูุงูุงุช ุงููุฑุณูุฉ |

**ุงุฎุชุจุงุฑ ุณุฑูุน:**

1. ุดุบูู ุงููุดุฑูุน ูุญููุงู:
```bash
npm run dev
```

2. ุงูุชุญ ุฃู ุตูุญุฉ ููุชุฌ
3. ุงุถุบุท ุนูู ุฒุฑ **"ุงุฏูุน ุงูุขู โก"**
4. ุงูุชุญ Developer Console (`F12`) ูุชุงุจุน ุงูุฑุณุงุฆู
5. ูุฌุจ ุฃู ูุชู ุชูุฌููู ุฅูู ุตูุญุฉ ุงูุฏูุน ูู Ziina

โ๏ธ **ููุงุญุธุฉ:** ููููู ุญุฐู ุฑุณุงุฆู console.log ุจุนุฏ ุงูุชุฃูุฏ ูู ุนูู ุงููุธุงู

---

### 5๏ธโฃ ุจุงุฑุงูุชุฑุงุช Payment Intent (API v2)

ูุธุงู ุงูุฏูุน ูุฑุณู ุงูุจุงุฑุงูุชุฑุงุช ุงูุชุงููุฉ ุฅูู Ziina API v2:

| ุงูุจุงุฑุงูุชุฑ | ุงููุตู | ูุซุงู |
|----------|-------|------|
| `amount` | ุงููุจูุบ ุจุงูููุณุงุช (ูุชู ุงูุชุญููู ุชููุงุฆูุงู) | `10500` (ูุนูู 105 ุฏุฑูู) |
| `currency_code` | ุฑูุฒ ุงูุนููุฉ (3 ุฃุญุฑู) | `AED` |
| `message` | ุฑุณุงูุฉ ุงูุฏูุน | `ุฏูุน ููุงุจู ุงุณู ุงูููุชุฌ` |
| `success_url` | ุฑุงุจุท ุงููุฌุงุญ | `https://yoursite.com/success` |
| `cancel_url` | ุฑุงุจุท ุงูุฅูุบุงุก | `https://yoursite.com/cancel` |
| `failure_url` | ุฑุงุจุท ุงููุดู | `https://yoursite.com/cancel` |
| `test` | ูุถุน ุงูุชุฌุฑุจุฉ | `true` ุฃู `false` |
| `expiry` | ุงูุชูุงุก ุงูุตูุงุญูุฉ (string ุจุงููููู ุซุงููุฉ - 10 ุฏูุงุฆู) | `(Date.now() + 10 * 60 * 1000).toString()` |
| `allow_tips` | ุงูุณูุงุญ ุจุงูุฅูุฑุงููุงุช | `false` |

**ููุงุญุธุงุช ูููุฉ:** 
- ูุญู ูุณุชุฎุฏู ุฏุงูุฉ `convertAEDtoFils()` ูุชุญููู ุงููุจูุบ ุชููุงุฆูุงู
- 1 ุฏุฑูู = 100 ููุณ
- Ziina ุชุชุทูุจ ุงููุจูุบ ุจุงูููุณุงุช ุฏุงุฆูุงู
- `expiry` ูุฌุจ ุฃู ูููู **string** ุจุงููููู ุซุงููุฉ (milliseconds)
- ุงููุฏุฉ: 10 ุฏูุงุฆู ูู ุงูุขู (600000 ูููู ุซุงููุฉ)
- ุงูุญุณุงุจ: `(Date.now() + 10 * 60 * 1000).toString()`
- ูุซุงู: `"1730715600000"` (string ุจุงููููู ุซุงููุฉ)

---

### 6๏ธโฃ ุตูุญุงุช ุงููุฌุงุญ ูุงูุฅูุบุงุก

ุชู ุฅูุดุงุก ุตูุญุชูู ุฌุงูุฒุชูู:

- โ **ุตูุญุฉ ุงููุฌุงุญ:** `/success`
  - ุชุธูุฑ ุนูุฏ ุฅููุงู ุงูุฏูุน ุจูุฌุงุญ
  - ุชุนุฑุถ ุฑุณุงูุฉ ุชุฃููุฏ ูุชูุฌููุงุช ูููุณุชุฎุฏู

- โ **ุตูุญุฉ ุงูุฅูุบุงุก/ุงููุดู:** `/cancel`
  - ุชุธูุฑ ุนูุฏ ุฅูุบุงุก ุงููุณุชุฎุฏู ููุฏูุน ุฃู ูุดูู
  - ุชุนุฑุถ ุฎูุงุฑุงุช ูููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู

---

## ๐ง ุงููููุงุช ุงูุชู ุชู ุฅูุดุงุคูุง/ุชุญุฏูุซูุง:

```
๐ ุงููุดุฑูุน
โโโ ๐ app/api/payment_intent/route.js        # API route ููุฏูุน (JavaScript + API v2)
โโโ ๐ app/success/page.tsx                   # ุตูุญุฉ ุงููุฌุงุญ
โโโ ๐ app/cancel/page.tsx                    # ุตูุญุฉ ุงูุฅูุบุงุก/ุงููุดู
โโโ ๐ components/ProductDetail.tsx           # ุชู ุฅุถุงูุฉ ุฒุฑ ุงูุฏูุน + ุงุณู ุงูููุชุฌ
โโโ ๐ .env.example                           # ูุซุงู ูููุชุบูุฑุงุช ุงูุจูุฆูุฉ
โโโ ๐ ZIINA_SETUP.md                         # ูุฐุง ุงูููู
```

---

## ๐ก ูุตุงุฆุญ ุฅุถุงููุฉ:

### ุชุฎุตูุต ุงููุจูุบ:
ูุชู ุญุณุงุจ ุงููุจูุบ ุชููุงุฆูุงู ุจูุงุกู ุนูู:
- ุงูุณุนุฑ ุงูุญุงูู ููููุชุฌ
- ุงูุนููุฉ ุงููุฎุชุงุฑุฉ ูู ูุจู ุงููุณุชุฎุฏู

### ุฏุนู ุงูุนููุงุช:
Ziina ุชุฏุนู:
- ุฏุฑูู ุฅูุงุฑุงุชู (AED) โ
- ุฑูุงู ุณุนูุฏู (SAR) โ
- ุฏููุงุฑ ูููุชู (KWD) โ
- ูุบูุฑูุง...

### ุงูุฃูุงู:
- โ ููุชุงุญ API ูุญููุธ ูู Backend ููุท
- โ ูุง ูุชู ุนุฑุถ ุงูููุชุงุญ ูู Front-End
- โ ุฌููุน ุงูุทูุจุงุช ูุดูุฑุฉ ุนุจุฑ HTTPS

---

## ๐ง ุงุณุชูุดุงู ุงูุฃุฎุทุงุก (Troubleshooting)

### ุงููุดููุฉ: "ZIINA_SECRET_KEY is not configured"

**ุงูุญู:**
1. ุชุฃูุฏ ูู ูุฌูุฏ ููู `.env.local` ูู ุฌุฐุฑ ุงููุดุฑูุน
2. ุชุฃูุฏ ูู ุฃู ุงูููู ูุญุชูู ุนูู: `ZIINA_SECRET_KEY=sk_test_...`
3. ุฃุนุฏ ุชุดุบูู ุฎุงุฏู ุงูุชุทููุฑ: `npm run dev`

### ุงููุดููุฉ: "No redirect URL received from Ziina"

**ุงูุญู:**
1. ุชุญูู ูู ุตุญุฉ ููุชุงุญ API
2. ุชุญูู ูู ุฃู ุงููุจูุบ ุตุญูุญ (ุฃูุซุฑ ูู 0)
3. ุฑุงุฌุน ุฑุณุงุฆู ุงูุฎุทุฃ ูู Console
4. ุชุฃูุฏ ูู ุตุญุฉ ุงูุจุงุฑุงูุชุฑุงุช ุงููุฑุณูุฉ

### ุงููุดููุฉ: "Payment creation failed"

**ุงูุฃุณุจุงุจ ุงููุญุชููุฉ:**
- ููุชุงุญ API ุฎุงุทุฆ ุฃู ููุชูู
- ุงููุจูุบ ุฃูู ูู ุงูุญุฏ ุงูุฃุฏูู
- currency_code ุบูุฑ ูุฏุนูู
- ุงูุจุงุฑุงูุชุฑุงุช ุงููุทููุจุฉ ูุงูุตุฉ

**ุงูุญู:**
- ุฑุงุฌุน ุฑุณุงูุฉ ุงูุฎุทุฃ ุงูููุตูุฉ ูู Console
- ุชุญูู ูู `โ Error details:` ููุญุตูู ุนูู ุงููุฒูุฏ ูู ุงููุนูููุงุช

### ุงููุดููุฉ: ุงููุจูุบ ุบูุฑ ุตุญูุญ ูู ุตูุญุฉ ุงูุฏูุน

**ุงูุญู:**
1. ุชุญูู ูู ุงููุจูุบ ุงูุฃุตูู: `๐ฐ Original amount`
2. ุชุญูู ูู ุงููุจูุบ ุงููุญูู: `๐ฐ Converted amount`
3. ุชุฃูุฏ ูู ุฃู ุงูุชุญููู ุตุญูุญ: `ุงููุจูุบ ร 100`
4. ูุซุงู: 105 AED = 10,500 fils

### ุงููุดููุฉ: redirect_url ูุง ูุนูู

**ุงูุญู:**
1. ุชุญูู ูู ูุฌูุฏ `redirect_url` ูู ุงูุฑุฏ: `โ Redirect URL:`
2. ุชุญูู ูู ููุฏ JavaScript ูู ProductDetail.tsx:
```javascript
if (data.redirect_url) {
  window.location.href = data.redirect_url;
}
```
3. ุงูุชุญ Browser Console ูุงุจุญุซ ุนู ุฃุฎุทุงุก JavaScript

---

## ๐ ุงููุณุงุนุฏุฉ ูุงูุฏุนู:

ุฅุฐุง ูุงุฌูุช ุฃู ูุดููุฉ:
1. ุชุญูู ูู Console ููุฃุฎุทุงุก
2. ุชุฃูุฏ ูู ุตุญุฉ ููุงุชูุญ API
3. ุชุญูู ูู ุฅุนุฏุงุฏุงุช Vercel Environment Variables
4. ุฑุงุฌุน ุชูุซูู Ziina: https://docs.ziina.com/

---

## โ ูุงุฆูุฉ ุงููุฑุงุฌุนุฉ ุงูููุงุฆูุฉ:

- [ ] ุชู ุงูุญุตูู ุนูู ููุงุชูุญ API ูู Ziina
- [ ] ุชู ุฅุถุงูุฉ ุงููุชุบูุฑุงุช ุงูุจูุฆูุฉ ูู `.env.local`
- [ ] ุชู ุฅุถุงูุฉ ุงููุชุบูุฑุงุช ุงูุจูุฆูุฉ ูู Vercel
- [ ] ุชู ุงุฎุชุจุงุฑ ุงูุฏูุน ูู ูุถุน ุงูุชุฌุฑุจุฉ
- [ ] ุชู ุชูุนูู ุงูุฏูุน ุงูุญูููู (ุนูุฏ ุงูุงุณุชุนุฏุงุฏ)

---

**๐ ูุจุฑูู! ูุธุงู ุงูุฏูุน ุฌุงูุฒ ููุงุณุชุฎุฏุงู!**
